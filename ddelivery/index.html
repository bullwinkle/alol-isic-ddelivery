---
title: Ddelivery
---


<!DOCTYPE html>
<html>
<head lang="en">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <meta charset="UTF-8">
    <title>DDelivery</title>
    <style>
        html,body,#widget {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        #widget {
            padding: 0px;
            position: relative;
        }
        #widget iframe {
            width: 100% !important;
            height: 100% !important;
            top: 0;
            left: 0;
        }

        .header,.content {
            box-sizing: border-box;
            padding: 10px;
            position: relative;
        }

        .header {
            height: 30px;
        }
        .content {
            height: calc(100vh - 30px);
        }
    </style>
</head>
<body>



<pre class="jekill">
    site: {{ site }}
    page: {{ page }}
    dir: {{ page.dir }}
    name: {{ page.name }}
    path: {{ page.path }}
    url: {{ page.url }}
</div>

<div class="content">

    <div id="widget"></div>

</div>k

<!-- Polyfills - fetch -->
<script type="text/javascript">
	!function(e){function t(e){if((e=String(e)).match(/[^\x00-\xFF]/))throw TypeError("Not a valid ByteString");return e}function r(e){return(e=String(e)).replace(/([\u0000-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDFFF])/g,function(e){return/^[\uD800-\uDFFF]$/.test(e)?"�":e})}function s(e){return 65535&e}function i(e){return String(e).replace(/[a-z]/g,function(e){return e.toUpperCase()})}function n(e){return"CONNECT"===(e=i(e))||"TRACE"===e||"TRACK"===e}function o(e){var t=i(e);return"DELETE"===t||"GET"===t||"HEAD"===t||"OPTIONS"===t||"POST"===t||"PUT"===t?t:e}function a(e){return/^[!#$%&'*+\-.09A-Z^_`a-z|~]+$/.test(e)}function h(e){return{"accept-charset":!0,"accept-encoding":!0,"access-control-request-headers":!0,"access-control-request-method":!0,connection:!0,"content-length":!0,cookie:!0,cookie2:!0,date:!0,dnt:!0,expect:!0,host:!0,"keep-alive":!0,origin:!0,referer:!0,te:!0,trailer:!0,"transfer-encoding":!0,upgrade:!0,"user-agent":!0,via:!0}[e=String(e).toLowerCase()]||"proxy-"===e.substring(0,6)||"sec-"===e.substring(0,4)}function u(e){return{"set-cookie":!0,"set-cookie2":!0}[e=String(e).toLowerCase()]}function d(e,t){return"accept"===(e=String(e).toLowerCase())||"accept-language"===e||"content-language"===e||"content-type"===e&&-1!==["application/x-www-form-encoded","multipart/form-data","text/plain"].indexOf(t)}function c(e){this._guard="none",this._headerList=[],e&&f(this,e)}function f(e,t){t instanceof c?t._headerList.forEach(function(t){e.append(t[0],t[1])}):Array.isArray(t)?t.forEach(function(t){if(!Array.isArray(t)||2!==t.length)throw TypeError();e.append(t[0],t[1])}):(t=Object(t),Object.keys(t).forEach(function(r){e.append(r,t[r])}))}function p(e){this._headers=e,this._index=0}function l(e){this._stream=e,this.bodyUsed=!1}function y(e,s){if(arguments.length<1)throw TypeError("Not enough arguments");if(l.call(this,null),this.method="GET",this.url="",this.headers=new c,this.headers._guard="request",this.referrer=null,this.mode=null,this.credentials="omit",e instanceof y){if(e.bodyUsed)throw TypeError();e.bodyUsed=!0,this.method=e.method,this.url=e.url,this.headers=new c(e.headers),this.headers._guard=e.headers._guard,this.credentials=e.credentials,this._stream=e._stream}else e=r(e),this.url=String(new URL(e,self.location));if("method"in(s=Object(s))){var i=t(s.method);if(n(i))throw TypeError();this.method=o(i)}"headers"in s&&(this.headers=new c,f(this.headers,s.headers)),"body"in s&&(this._stream=s.body),"credentials"in s&&-1!==["omit","same-origin","include"].indexOf(s.credentials)&&(this.credentials=s.credentials)}function _(e,t){if(arguments.length<1&&(e=""),this.headers=new c,this.headers._guard="response",e instanceof XMLHttpRequest&&"_url"in e){var i=e;return this.type="basic",this.url=r(i._url),this.status=i.status,this.ok=200<=this.status&&this.status<=299,this.statusText=i.statusText,i.getAllResponseHeaders().split(/\r?\n/).filter(function(e){return e.length}).forEach(function(e){var t=e.indexOf(":");this.headers.append(e.substring(0,t),e.substring(t+2))},this),void l.call(this,i.responseText)}l.call(this,e),t=Object(t)||{},this.url="";var n="status"in t?s(t.status):200;if(n<200||n>599)throw RangeError();this.status=n,this.ok=200<=this.status&&this.status<=299;var o="statusText"in t?String(t.statusText):"OK";if(/[^\x00-\xFF]/.test(o))throw TypeError();this.statusText=o,"headers"in t&&f(this.headers,t),this.type="basic"}function g(e,t){return new Promise(function(r,s){var i=new y(e,t),n=new XMLHttpRequest;n._url=i.url;try{n.open(i.method,i.url,!0)}catch(e){throw TypeError(e.message)}for(var o=i.headers[Symbol.iterator](),a=o.next();!a.done;a=o.next())n.setRequestHeader(a.value[0],a.value[1]);"include"===i.credentials&&(n.withCredentials=!0),n.onreadystatechange=function(){n.readyState===XMLHttpRequest.DONE&&(0===n.status?s(new TypeError("Network error")):r(new _(n)))},n.send(i._stream)})}c.prototype={append:function(e,r){if(e=t(e),!a(e))throw TypeError();if("immutable"===this._guard)throw TypeError();"request"===this._guard&&h(e)||("request-no-CORS"!==this._guard||d(e,r))&&("response"===this._guard&&u(e)||(e=e.toLowerCase(),this._headerList.push([e,r])))},delete:function(e){if(e=t(e),!a(e))throw TypeError();if("immutable"===this._guard)throw TypeError();if(("request"!==this._guard||!h(e))&&("request-no-CORS"!==this._guard||d(e,"invalid"))&&("response"!==this._guard||!u(e))){e=e.toLowerCase();for(var r=0;r<this._headerList.length;)this._headerList[r][0]===e?this._headerList.splice(r,1):++r}},get:function(e){if(e=t(e),!a(e))throw TypeError();e=e.toLowerCase();for(var r=0;r<this._headerList.length;++r)if(this._headerList[r][0]===e)return this._headerList[r][1];return null},getAll:function(e){if(e=t(e),!a(e))throw TypeError();e=e.toLowerCase();for(var r=[],s=0;s<this._headerList.length;++s)this._headerList[s][0]===e&&r.push(this._headerList[s][1]);return r},has:function(e){if(e=t(e),!a(e))throw TypeError();e=e.toLowerCase();for(var r=0;r<this._headerList.length;++r)if(this._headerList[r][0]===e)return!0;return!1},set:function(e,r){if(e=t(e),!a(e))throw TypeError();if("immutable"===this._guard)throw TypeError();if(("request"!==this._guard||!h(e))&&("request-no-CORS"!==this._guard||d(e,r))&&("response"!==this._guard||!u(e))){e=e.toLowerCase();for(var s=0;s<this._headerList.length;++s)if(this._headerList[s][0]===e){for(this._headerList[s++][1]=r;s<this._headerList.length;)this._headerList[s][0]===e?this._headerList.splice(s,1):++s;return}this._headerList.push([e,r])}}},c.prototype[Symbol.iterator]=function(){return new p(this)},p.prototype={},p.prototype.next=function(){return this._index>=this._headers._headerList.length?{value:void 0,done:!0}:{value:this._headers._headerList[this._index++],done:!1}},p.prototype[Symbol.iterator]=function(){return this},l.prototype={arrayBuffer:function(){if(this.bodyUsed)return Promise.reject(TypeError());if(this.bodyUsed=!0,this._stream instanceof ArrayBuffer)return Promise.resolve(this._stream);var e=this._stream;return new Promise(function(t,r){var s=unescape(encodeURIComponent(e)).split("").map(function(e){return e.charCodeAt(0)});t(new Uint8Array(s).buffer)})},blob:function(){return this.bodyUsed?Promise.reject(TypeError()):(this.bodyUsed=!0,this._stream instanceof Blob?Promise.resolve(this._stream):Promise.resolve(new Blob([this._stream])))},formData:function(){return this.bodyUsed?Promise.reject(TypeError()):(this.bodyUsed=!0,this._stream instanceof FormData?Promise.resolve(this._stream):Promise.reject(Error("Not yet implemented")))},json:function(){if(this.bodyUsed)return Promise.reject(TypeError());this.bodyUsed=!0;var e=this;return new Promise(function(t,r){t(JSON.parse(e._stream))})},text:function(){return this.bodyUsed?Promise.reject(TypeError()):(this.bodyUsed=!0,Promise.resolve(String(this._stream)))}},y.prototype=l.prototype,_.prototype=l.prototype,_.redirect=function(){throw Error("Not supported")},"fetch"in e||(e.Headers=c,e.Request=y,e.Response=_,e.fetch=g)}(self);
</script>


<!-- DDeliveryWidget -->
<script type="text/javascript">
	window['DDeliveryWidget'] = (function () {

		var ENV_PROD = 'prod', ENV_DEV = 'dev',
			error = true, errorMessage = '',
			path = {
				map: '',
				index: ''
			},
			deliveryIframe = document.createElement('iframe'),
			deliveryMap = document.createElement('iframe'),
			params = {
				id: 0,
				name: 'ddelivery-widget',
				env: ENV_PROD,
				url: {
					dev: 'http://sdk2.dev.ddelivery.ru/api/v1/integration/module.json',
					prod: 'https://sdk.ddelivery.ru/api/v1/integration/module.json'
				},
				width: 400,
				height: 500,
				products: []

			}, element, sendParams = ['id', 'products'];

		var run = function () {
				var iframe = createIframe();
				element.appendChild(iframe);
			},

			setTokenValue = function (token) {
				window['localStorage']['dd_sdk_module.ttl_token'] = token;
			},

			getTokenValue = function () {
				return window['localStorage']['dd_sdk_module.ttl_token'] || '';
			},

			serialize = function (obj, prefix) {
				var str = [], p;
				for (p in obj) {
					if (obj.hasOwnProperty(p)) {
						var k = prefix ? prefix + "[" + p + "]" : p, v = obj[p];
						str.push((v !== null && typeof v === "object") ?
							serialize(v, k) :
							encodeURIComponent(k) + "=" + encodeURIComponent(v));
					}
				}
				return str.join("&");
			},
			getUrl = function () {

				if(path.index != ''){
					return path.index;
				}

				var url = params['url'][params['env']];
				var query = {};

				for (var i = 0; i < sendParams.length; i++) {
					if (typeof params[sendParams[i]] != 'undefined') {
						query[sendParams[i]] = params[sendParams[i]];
					}
				}

				query['token'] = getTokenValue();
				url += '?' + serialize(query);

				return url;
			},


			createMapIframe = function(data){
				var doc = document.documentElement;
				var left = (window.pageXOffset || doc.scrollLeft) - (doc.clientLeft || 0);
				var top = (window.pageYOffset || doc.scrollTop) - (doc.clientTop || 0);
				var height = "innerHeight" in window ? window.innerHeight : document.documentElement.offsetHeight;

				path.map = data.location;
				deliveryMap.style.width = '100%';
				deliveryMap.style.height = height + 'px'; //'100%';
				//alert( window.innerHeight );
				//deliveryMap.style.position = 'fixed';
				deliveryMap.style.overflowX = 'hidden';
				deliveryMap.style.display = "block";
				deliveryMap.scrolling = 'no';
				deliveryMap.frameBorder = 0;
				deliveryMap.style.borderWidth = 0;
				deliveryMap.style.position = "absolute";
				//deliveryMap.style.position = 'fixed';
				deliveryMap.style.top = top + "px";
				deliveryMap.style.left = left + "px";
				deliveryMap.style.background = "transparent";
				deliveryMap.style.zIndex = "10000";
				deliveryMap.src = path.map;
				document.body.appendChild(deliveryMap);
			},

			createIframe = function () {
				element.innerHTML = '';
				deliveryIframe.setAttribute("name", params['name']);
				deliveryIframe.style.width = params['width'] + 'px';
				deliveryIframe.style.height = params['height'] + 'px';
				deliveryIframe.style.overflow = 'hidden';
				deliveryIframe.scrolling = 'no';
				deliveryIframe.frameBorder = 0;
				deliveryIframe.style.borderWidth = 0;
				deliveryIframe.style.position = "absolute";
				deliveryIframe.style.background = "transparent";
				deliveryIframe.src = getUrl();

				if (typeof (window.addEventListener) != 'undefined') { // ALL kind
					window.addEventListener("message", iframeEventsHandler, false);
				} else { // IE
					window.attachEvent("onmessage", iframeEventsHandler);
				}

				return deliveryIframe;

			},

			configure = function (defaultParams, input) {
				for (var item in input) {
					if (typeof defaultParams[item] != 'undefined') {
						defaultParams[item] = input[item];
					}
				}
				return defaultParams;
			},

			iframeEventsHandler = function (event) {
				var data;
				if (typeof event['data'] == 'undefined') {
					return;
				}
				data = event['data'];
				if (typeof data['indexOf'] == 'undefined') {
					return;
				}

				var pos = data.indexOf('"action"');
				if (pos == -1) {
					return;
				}
				data = JSON.parse(data);
				if (typeof data['action'] != 'undefined' && typeof callbacks[data['action']] == 'function') {
					if(params.env == ENV_DEV){
						console.log("event name: " + data['action']);
						console.log("params");
						console.log(data['data']);
					}
					callbacks[data['action']](data['data']);
				}

			},

			callbacks = {

				// map point selection
				select: function (data) {

					deliveryMap.style.display = 'none';
					path.index = data['index'];
					deliveryIframe.src = path.index;
					deliveryIframe.focus();

				},

				token: function (data) {
					setTokenValue(data['token']);
				},

				update: function(data){
					if(typeof data['error'] != 'undefined'){
						error = true;
						errorMessage = data['error_message']
					}else {
						error = false;
						errorMessage = "";
						this.change(data);
					}
				},

				change: function (data) {
					if(params.env == ENV_DEV) {
						//console.log(data);
					}
				},

				price: function (data) {
					if(params.env == ENV_DEV) {
						//console.log(data);
					}
				},

				close: function (data) {
					deliveryMap.style.display = 'none';
				},

				resize: function (data) {
					deliveryIframe.style.height = data.height + 'px';
				},

				// РР·РјРµРЅРµРЅРёСЏ С†РµРЅС‹
				src: function (data) {
					path.map = data['map'] || '';
					path.index = data['index'] || '';
				},

				map: createMapIframe

			};

		return {

			ENV_DEV: ENV_DEV,
			ENV_PROD: ENV_PROD,

			validate: function () {
				return !error;
			},

			getErrorMsg:function(){
				return errorMessage;
			},

			init: function (id, userParams, userCallbacks) {
				element = document.getElementById(id);

				if (userCallbacks != null) {
					callbacks = configure(callbacks, userCallbacks);
				}

				if (userParams != null) {
					params = configure(params, userParams);
				}

				run();
			}
		}
	})();
</script>


<!-- App -->
<script type="text/javascript">


	/**
     * This app is for shiwing inside WebView. Tasks are:
     * 1. Show widget to select delivery method and address
     * 2. Pass info about selected method and address back to parent app
     *    with going for specified url with params
	 */

	var isicStoreId = 71878;
	var nativeAppBridgeKey = '__NATIVE_APP_BRIDGE';
	var isicProductsUrl = 'https://stage.alol.io/rest/2.0/isic-cards-list';

	var isicApiKey = 'd9a0b7073a2ff803c42beda4e1cb66cd';
	var isicActivationLink = `https://sdk.ddelivery.ru/api/v1/integration/d9a0b7073a2ff803c42beda4e1cb66cd/link.json`; // id: 71878
	var isicDeactivationLink = `https://sdk.ddelivery.ru/api/v1/integration/d9a0b7073a2ff803c42beda4e1cb66cd/reset.json`;
	var isicSettingsLink = `https://sdk.ddelivery.ru/api/v1/integration/d9a0b7073a2ff803c42beda4e1cb66cd/pam.json`;

	var DDeliveryProductDefaults = {
		id: 0,
		name: 'Карта ISIC',
		price: 600,
		width: 33,
		height: 20,
		length: 1,
		weight: 0.1,
		quantity: 1,
		sku: 'SKU PRODUCT'
	};

	function formatResult (data) {
		return data
	}

	function submit (data) {
		try {
//			window[nativeAppBridgeKey](formatResult(data));
			window.webkit.messageHandlers.buttonClicked.postMessage(formatResult(data));
            return true
		} catch (e) {
			console.warn(e)
			return false
		}
	}

    function initDDeliveryWidget (orderedProducts) {
		console.warn('isicProducts',orderedProducts);
		window.localStorage.clear();

		DDeliveryWidget.init('widget', {
			products: orderedProducts,
			id: isicStoreId,
			env: DDeliveryWidget.ENV_PROD
		}, {
			price: function (data) {
				console.log('price');
				console.log(data);
			},
			change: function (data) {
				console.log('change',data);
				submit(data)
			}
		});
    }

	function startDdeliveryOrderProcedure (selectedProductIds) {
		if (selectedProductIds == null) selectedProductIds = [];

		fetch(isicProductsUrl)
            .then(function (res) {return res.json()})
            .then(function (res) {
                var isicProducts = res && res.data && res.data.items || [];

				var orderedProducts = isicProducts
					.filter(function (el) { return selectedProductIds.includes(el.id) })
					.map(function (el) { return Object.assign({},DDeliveryProductDefaults,el)});

                initDDeliveryWidget(orderedProducts);
            })
            .catch(function (err) {
            	console.warn('get products error',err)
                alert('Не удалось получить список карт')
            });
    }

    function TEST_startDdeliveryOrderProcedure () {
		startDdeliveryOrderProcedure([1])
    }

	window.startDdeliveryOrderProcedure = startDdeliveryOrderProcedure;

</script>

</body>